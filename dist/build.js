(()=>{"use strict";console.log("Hi"),Vue.component("server-error",{template:'<h3 class="goods-null" v-if="iserror">Ошибка сервера</h3>',props:["iserror"]}),Vue.component("cart",{template:'\n            <div v-if="visible" class="cart-list" >\n                <div class="cart-list__price">Сумма товаров: {{price}}</div>\n                <div class="cart-item" v-for="item in cart">\n                <div class="cart-item__img"></div>\n                <h3 class="cart-item__title">{{item.product_name}}</h3>\n                <p class="cart-item__price">Цена: {{item.price}} у.е.</p>\n                <button type="button"  name="delete" class="cart-item__qnt" v-bind:data-qntid="item.id_product" v-on:click="deleteQuantity">-</button>\n                <span class="cart-item__quantity">Количество: <b>{{item.qnt}}</b></span>\n                <button type="button"  name="add" class="cart-item__qnt" v-bind:data-qntid="item.id_product" v-on:click="addQuantity">+</button>\n                        <div class="cart-item__delete">\n                            <button class="cart-item__button" v-bind:data-id="item.id_product" v-on:click="deleteFromCartHandler">Удалить из корзины</button>\n                        </div>\n                </div>                  \n            </div>\n        ',props:["visible","price","cart"],methods:{deleteQuantity(t){this.$emit("delete-qnt",t)},addQuantity(t){this.$emit("add-qnt",t)},deleteFromCartHandler(t){this.$emit("delete-from-cart",t)}}}),Vue.component("goods-list",{template:'<div class="goods-list">\n                        <h3 class="goods-null" v-if="goods.length == 0">Нет данных / Товары не найдены</h3>\n                        <goods-item v-for="good in goods" :good="good" v-bind:key="good.id_product" v-on:add-to-cart="addToCartHandler">\n                        </goods-item>\n                    </div>',props:["goods"],methods:{addToCartHandler(t){this.$emit("add-to-cart2",t)}}}),Vue.component("goods-item",{template:'<div class="goods-item">\n                        <div class="goods-item__img"></div>\n                        <h3 class="goods-item__title">{{ good.product_name }}\n                        </h3><p class="goods-item__price">Цена:{{ good.price }} у.е.</p>\n                        <button class="goods-item-button" v-on:click="addToCartHandler" v-bind:id="good.id_product">Добавить</button>   \n                    </div>\n        ',props:["good"],methods:{addToCartHandler(t){this.$emit("add-to-cart",t)}}}),Vue.component("searching",{template:'<div><input id="search" v-model="searchLine" v-on:input="isSearchHandler" placeholder="Фильтр товаров.."> </div>',data:()=>({searchLine:""}),methods:{isSearchHandler(t){this.$emit("searchitem",this.searchLine)}}}),new Vue({el:"#app",data:{urlGet:"catalogData",urlPostAdd:"addToCart",urlPostDelete:"deleteToCart",urladdQnt:"addQntToCart",urlDelQnt:"deleteQntToCart",urlGetCart:"cartData",goods:[],filteredGoods:[],cartItems:[],isVisibleCart:!1,isError:!1,cartApi:[]},computed:{summCartItemsquant(){let t=0;return this.cartItems.forEach((({qnt:e})=>{t+=e})),t},totalPrice(){let t=0;return this.cartItems.forEach((({price:e,qnt:s})=>{t+=s*e})),t}},methods:{searchHandler(t){""===t&&(this.filteredGoods=this.goods);const e=new RegExp(t,"gi");this.filteredGoods=this.goods.filter((t=>e.test(t.product_name)))},addToCartHandler(t){const e=t.target.id;let s=this.cartItems.findIndex((t=>t.id_product==e));if(-1==s){const t=this.goods.find((t=>t.id_product==e));let{product_name:s,price:i}=t,d={product_name:s,price:i,id_product:e,qnt:1};this.cartItems.push(d),this.fetchPromisePOST(this.urlPostAdd,d)}else{this.cartItems[s].qnt=parseInt(this.cartItems[s].qnt)+1;let t={id_product:e,addQnt:1};this.fetchPromisePOST(this.urladdQnt,t)}this.isVisibleCart=!0},deleteFromCartHandler(t){const e=t.target.dataset.id;let s=this.cartItems.findIndex((t=>t.id_product==e));this.fetchPromisePOST(this.urlPostDelete,this.cartItems[s]),this.cartItems.splice(s,1)},showCart(){this.isVisibleCart=!this.isVisibleCart},deleteQuantity(t){const e=t.target.dataset.qntid;this.fetchPromisePOST(this.urlDelQnt,{id_product:e});let s=this.cartItems.findIndex((t=>t.id_product==e));this.cartItems[s].qnt>1?this.cartItems[s].qnt=parseInt(this.cartItems[s].qnt)-1:this.cartItems.splice(s,1)},addQuantity(t){const e=t.target.dataset.qntid;let s=this.cartItems.findIndex((t=>t.id_product==e));this.cartItems[s].qnt=parseInt(this.cartItems[s].qnt)+1;let i={id_product:e,addQnt:1};this.fetchPromisePOST(this.urladdQnt,i)},fetchGET(t,e,s){let i;window.XMLHttpRequest?i=new XMLHttpRequest:window.ActiveXObject&&(i=new ActiveXObject("Microsoft.XMLHTTP")),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?e(JSON.parse(i.responseText)):i.status>400&&t("все пропало"))},i.open("GET",`./${s}`,!0),i.send()},fetchPOST(t,e,s,i){let d;window.XMLHttpRequest?d=new XMLHttpRequest:window.ActiveXObject&&(d=new ActiveXObject("Microsoft.XMLHTTP")),d.onreadystatechange=function(){4===d.readyState&&(200===d.status?e(d.responseText):d.status>400&&t("все пропало"))},d.open("POST",`./${s}`,!0),d.setRequestHeader("Content-Type","application/json; charset=UTF-8"),d.send(JSON.stringify(i))},fetchPromiseGET(t){return new Promise(((e,s)=>{this.fetchGET(s,e,t)}))},fetchPromisePOST(t,e){return new Promise(((s,i)=>{this.fetchPOST(i,s,t,e)}))}},mounted(){this.fetchPromiseGET(this.urlGet).then((t=>{this.goods=t,this.filteredGoods=t,this.fetchPromiseGET(this.urlGetCart).then((t=>{this.cartItems=t,console.log(this.cartItems)}))})).catch((t=>{this.isError=!0,console.log(this.isError)}))}})})();